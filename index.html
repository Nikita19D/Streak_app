<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Streak Tracker</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; }
    * { box-sizing: border-box; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;

    const getToday = () => new Date().toISOString().split('T')[0];
    const generateId = () => Math.random().toString(36).substr(2, 9);

    // Fire Animation Component
    const FireAnimation = ({ streak, style = 'demonslayer' }) => {
      let color = '#FB923C';
      let secondaryColor = '#F97316';
      
      if (streak >= 100) {
        color = '#3B0764';
        secondaryColor = '#7C3AED';
      } else if (streak >= 50) {
        color = '#581C87';
        secondaryColor = '#A855F7';
      } else if (streak >= 10) {
        color = '#C4B5FD';
        secondaryColor = '#8B5CF6';
      } else if (streak >= 5) {
        color = '#A855F7';
        secondaryColor = '#C084FC';
      }

      if (style === 'getsuga') {
        return (
          <div className="relative flex items-center justify-center w-20 h-24">
            <svg width="80" height="100" className="absolute" style={{ filter: 'drop-shadow(0 0 15px rgba(59, 130, 246, 0.8))' }}>
              <defs>
                <linearGradient id={`getsugatGrad-${streak}`} x1="0%" y1="0%" x2="0%" y2="100%">
                  <stop offset="0%" stopColor="#3B82F6" stopOpacity="0.9" />
                  <stop offset="50%" stopColor={color} stopOpacity="0.8" />
                  <stop offset="100%" stopColor="#1E3A8A" stopOpacity="0.3" />
                </linearGradient>
              </defs>
              
              <path d="M 15 75 Q 10 55 15 35 Q 20 20 30 10 L 40 5 L 50 10 Q 60 20 65 35 Q 70 55 65 75 L 40 85 Z" 
                    fill={`url(#getsugatGrad-${streak})`}
                    stroke="#3B82F6"
                    strokeWidth="1"
                    opacity="0.85">
                <animate attributeName="d" 
                         values="M 15 75 Q 10 55 15 35 Q 20 20 30 10 L 40 5 L 50 10 Q 60 20 65 35 Q 70 55 65 75 L 40 85 Z;M 15 75 Q 8 52 18 32 Q 22 18 32 8 L 40 3 L 48 8 Q 58 18 62 32 Q 72 52 65 75 L 40 85 Z;M 15 75 Q 10 55 15 35 Q 20 20 30 10 L 40 5 L 50 10 Q 60 20 65 35 Q 70 55 65 75 L 40 85 Z" 
                         dur="2s" 
                         repeatCount="indefinite" />
              </path>

              {[...Array(6)].map((_, i) => (
                <line 
                  key={i}
                  x1={20 + i * 8} 
                  y1="80"
                  x2={25 + i * 8}
                  y2="10"
                  stroke="#60A5FA"
                  strokeWidth="2"
                  strokeLinecap="round"
                  opacity="0">
                  <animate 
                    attributeName="opacity" 
                    values="0;0.8;0" 
                    dur={`${1.2 + (i * 0.15)}s`} 
                    repeatCount="indefinite"
                    begin={`${i * 0.2}s`} />
                </line>
              ))}
            </svg>
            
            <div className="absolute text-2xl font-bold text-white z-10" 
                 style={{ 
                   textShadow: `0 0 10px #3B82F6, 2px 2px 8px rgba(0,0,0,0.9)`,
                   fontWeight: '900'
                 }}>
              {streak}
            </div>
          </div>
        );
      }

      return (
        <div className="relative flex items-center justify-center w-20 h-24">
          <svg width="80" height="100" className="absolute">
            <defs>
              <radialGradient id={`fireGrad-${streak}`}>
                <stop offset="0%" stopColor="#FCD34D" />
                <stop offset="50%" stopColor={color} />
                <stop offset="100%" stopColor={color} stopOpacity="0.3" />
              </radialGradient>
            </defs>
            <ellipse cx="40" cy="70" rx="20" ry="35" fill={`url(#fireGrad-${streak})`}>
              <animate attributeName="ry" values="35;40;35" dur="1.5s" repeatCount="indefinite" />
            </ellipse>
          </svg>
          <div className="absolute text-2xl font-bold text-white z-10" style={{ textShadow: '2px 2px 8px rgba(0,0,0,0.8)' }}>
            {streak}
          </div>
        </div>
      );
    };

    // Initialize demo data
    const initData = () => {
      const habits = [
        { id: 'h1', name: '🏃 Morning Exercise', description: 'Daily workout routine', mode: 'habit', createdDate: '2024-10-15', currentStreak: 15, longestStreak: 18 },
        { id: 'h2', name: '📚 Daily Reading', description: 'Read for 30 minutes', mode: 'habit', createdDate: '2024-10-07', currentStreak: 23, longestStreak: 23 },
        { id: 'h3', name: '🇪🇸 Learn Spanish', description: 'Practice Spanish daily', mode: 'progress', createdDate: '2024-10-22', currentStreak: 8, longestStreak: 12 },
      ];

      const checkIns = [];
      const today = new Date();
      
      habits.forEach(habit => {
        for (let i = habit.currentStreak - 1; i >= 0; i--) {
          const date = new Date(today);
          date.setDate(date.getDate() - i);
          const dateStr = date.toISOString().split('T')[0];
          
          const notes = i === 0 
            ? 'Completed 30 min run in the park, followed by 15 min stretching. Felt energized!'
            : 'Great session today! Staying consistent with my routine.';
          const rating = Math.floor(Math.random() * 3) + 7;
          
          checkIns.push({
            id: generateId(),
            habitId: habit.id,
            date: dateStr,
            notes,
            completed: true,
            aiRating: rating,
            aiFeedback: 'Great work! Your consistency is building momentum.',
            aiAdvice: 'Try adding more specific details about your progress.'
          });
        }
      });

      return { habits, checkIns, holidays: [] };
    };

    // Main App Component
    function App() {
      const [view, setView] = useState('dashboard');
      const [habits, setHabits] = useState([]);
      const [checkIns, setCheckIns] = useState([]);
      const [toast, setToast] = useState('');
      const [modal, setModal] = useState(null);
      const [formData, setFormData] = useState({});
      const [selectedHabit, setSelectedHabit] = useState(null);
      const [hfToken, setHfToken] = useState('');
      const [hfModel, setHfModel] = useState('microsoft/Phi-3-mini-4k-instruct');
      const [isTokenSaved, setIsTokenSaved] = useState(false);
      const [loadingAI, setLoadingAI] = useState(false);

      useEffect(() => {
        const stored = localStorage.getItem('streakData');
        if (stored) {
          const data = JSON.parse(stored);
          setHabits(data.habits || []);
          setCheckIns(data.checkIns || []);
        } else {
          const data = initData();
          setHabits(data.habits);
          setCheckIns(data.checkIns);
        }
        
        const savedToken = localStorage.getItem('hf_token');
        const savedModel = localStorage.getItem('hf_model');
        if (savedToken) {
          setHfToken(savedToken);
          setIsTokenSaved(true);
        }
        if (savedModel) setHfModel(savedModel);
      }, []);

      useEffect(() => {
        if (habits.length > 0) {
          localStorage.setItem('streakData', JSON.stringify({ habits, checkIns }));
        }
      }, [habits, checkIns]);

      const showToast = (msg) => {
        setToast(msg);
        setTimeout(() => setToast(''), 3000);
      };

      const addHabit = () => {
        const newHabit = {
          id: generateId(),
          name: formData.name,
          description: formData.description,
          mode: formData.mode || 'habit',
          createdDate: getToday(),
          currentStreak: 0,
          longestStreak: 0
        };
        setHabits([...habits, newHabit]);
        setModal(null);
        showToast('Habit added!');
      };

      const checkIn = (habitId) => {
        const today = getToday();
        const existing = checkIns.find(c => c.habitId === habitId && c.date === today);
        
        if (existing) {
          showToast('Already checked in today!');
          return;
        }

        const newCheckIn = {
          id: generateId(),
          habitId,
          date: today,
          notes: formData.notes || 'Completed today',
          completed: true,
          aiRating: null,
          aiFeedback: null,
          aiAdvice: null
        };

        const habit = habits.find(h => h.id === habitId);
        const updatedHabit = {
          ...habit,
          currentStreak: habit.currentStreak + 1,
          longestStreak: Math.max(habit.longestStreak, habit.currentStreak + 1)
        };

        setCheckIns([...checkIns, newCheckIn]);
        setHabits(habits.map(h => h.id === habitId ? updatedHabit : h));
        setModal(null);
        showToast('Checked in! 🔥');
      };

      const getAIFeedback = async (checkInId) => {
        if (!hfToken) {
          showToast('❌ Please configure your Hugging Face token in Settings');
          return;
        }

        setLoadingAI(true);
        const checkIn = checkIns.find(c => c.id === checkInId);
        const habit = habits.find(h => h.id === checkIn.habitId);

        try {
          const response = await fetch(`https://api-inference.huggingface.co/models/${hfModel}`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${hfToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              inputs: `Analyze this habit entry and respond with JSON only: {"rating": 8, "feedback": "Great work!", "advice": "Keep it up"}

Habit: ${habit.name}
Notes: ${checkIn.notes}

Rate 1-10 and give encouraging feedback.`,
              parameters: {
                max_new_tokens: 200,
                temperature: 0.7
              }
            })
          });

          if (!response.ok) throw new Error('API failed');

          const data = await response.json();
          let result = data[0]?.generated_text || JSON.stringify(data);
          
          const jsonMatch = result.match(/\{[\s\S]*\}/);
          let feedback = {
            rating: 8,
            feedback: 'Great consistency! Keep building that habit.',
            advice: 'Try adding more detail to track progress better.'
          };

          if (jsonMatch) {
            feedback = JSON.parse(jsonMatch[0]);
          }

          const updatedCheckIn = {
            ...checkIn,
            aiRating: Math.min(Math.max(feedback.rating, 1), 10),
            aiFeedback: feedback.feedback,
            aiAdvice: feedback.advice
          };

          setCheckIns(checkIns.map(c => c.id === checkInId ? updatedCheckIn : c));
          showToast('✅ AI feedback received!');
        } catch (error) {
          console.error('AI Error:', error);
          showToast('⚠️ Using smart analysis (API failed)');
          
          const wordCount = checkIn.notes.split(/\s+/).length;
          const rating = wordCount > 50 ? 8 : 7;
          
          const updatedCheckIn = {
            ...checkIn,
            aiRating: rating,
            aiFeedback: 'Good work! Your consistency is key to success.',
            aiAdvice: 'Consider adding more specific details about your accomplishments.'
          };
          
          setCheckIns(checkIns.map(c => c.id === checkInId ? updatedCheckIn : c));
        } finally {
          setLoadingAI(false);
        }
      };

      const saveToken = () => {
        if (hfToken.trim()) {
          localStorage.setItem('hf_token', hfToken);
          setIsTokenSaved(true);
          showToast('✅ Token saved!');
        }
      };

      // Dashboard View
      const renderDashboard = () => (
        <div className="p-6">
          <h1 className="text-3xl font-bold text-white mb-6">Dashboard</h1>
          
          {habits.length === 0 ? (
            <div className="text-center py-12">
              <p className="text-2xl text-gray-400 mb-6">"The secret of getting ahead is getting started."</p>
              <button 
                onClick={() => { setModal('addHabit'); setFormData({}); }}
                className="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700">
                Add Your First Habit
              </button>
            </div>
          ) : (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {habits.map(habit => (
                <div 
                  key={habit.id} 
                  onClick={() => setSelectedHabit(habit)}
                  className="bg-gray-800 rounded-lg p-6 cursor-pointer hover:bg-gray-700 transition">
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="text-xl font-bold text-white">{habit.name}</h3>
                    <FireAnimation streak={habit.currentStreak} style="getsuga" />
                  </div>
                  <p className="text-gray-400 text-sm mb-4">{habit.description}</p>
                  <div className="flex justify-between text-sm">
                    <span className="text-green-400">Current: {habit.currentStreak}</span>
                    <span className="text-blue-400">Best: {habit.longestStreak}</span>
                  </div>
                  <button 
                    onClick={(e) => { e.stopPropagation(); setModal('checkIn'); setFormData({ habitId: habit.id }); }}
                    className="w-full mt-4 bg-green-600 text-white py-2 rounded hover:bg-green-700">
                    ✓ Check In Today
                  </button>
                </div>
              ))}
            </div>
          )}

          <button 
            onClick={() => { setModal('addHabit'); setFormData({}); }}
            className="fixed bottom-6 right-6 bg-blue-600 text-white p-4 rounded-full shadow-lg hover:bg-blue-700 text-2xl">
            +
          </button>
        </div>
      );

      // Habit Detail View
      const renderHabitDetail = () => {
        if (!selectedHabit) return null;
        
        const habitCheckIns = checkIns.filter(c => c.habitId === selectedHabit.id).sort((a, b) => b.date.localeCompare(a.date));
        
        return (
          <div className="p-6">
            <button onClick={() => setSelectedHabit(null)} className="text-blue-400 mb-4">← Back</button>
            <h1 className="text-3xl font-bold text-white mb-6">{selectedHabit.name}</h1>
            
            <div className="space-y-4">
              {habitCheckIns.map(checkIn => (
                <div key={checkIn.id} className="bg-gray-800 rounded-lg p-6">
                  <div className="flex justify-between items-start mb-4">
                    <div>
                      <p className="text-gray-400 text-sm">{checkIn.date}</p>
                      <p className="text-white mt-2">{checkIn.notes}</p>
                    </div>
                    {checkIn.aiRating && (
                      <div className="text-right">
                        <div className="text-2xl font-bold text-yellow-400">{checkIn.aiRating}/10</div>
                      </div>
                    )}
                  </div>
                  
                  {checkIn.aiRating ? (
                    <div className="space-y-3">
                      <div className="bg-blue-900/30 p-4 rounded">
                        <p className="text-blue-300">{checkIn.aiFeedback}</p>
                      </div>
                      <div className="bg-green-900/30 p-4 rounded">
                        <p className="text-sm text-gray-400 mb-1">💡 Advice:</p>
                        <p className="text-green-300">{checkIn.aiAdvice}</p>
                      </div>
                    </div>
                  ) : (
                    <button 
                      onClick={() => getAIFeedback(checkIn.id)}
                      disabled={loadingAI}
                      className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 disabled:opacity-50">
                      {loadingAI ? 'Analyzing...' : 'Get AI Feedback'}
                    </button>
                  )}
                </div>
              ))}
            </div>
          </div>
        );
      };

      // Settings View
      const renderSettings = () => (
        <div className="p-6 max-w-2xl">
          <h1 className="text-3xl font-bold text-white mb-6">Settings</h1>
          
          <div className="bg-gray-800 rounded-lg p-6 mb-6">
            <h2 className="text-xl font-bold text-white mb-4">AI Configuration</h2>
            
            <div className="mb-4">
              <label className="block text-gray-400 text-sm mb-2">Hugging Face Token</label>
              <div className="flex gap-2">
                <input 
                  type="password"
                  value={hfToken}
                  onChange={(e) => setHfToken(e.target.value)}
                  placeholder="hf_..."
                  className="flex-1 bg-gray-700 text-white px-4 py-2 rounded" />
                <button 
                  onClick={saveToken}
                  className="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">
                  Save
                </button>
              </div>
              {isTokenSaved && <p className="text-green-400 text-sm mt-2">✓ Token saved</p>}
              <p className="text-gray-500 text-sm mt-2">
                Get free token at: <a href="https://huggingface.co/settings/tokens" target="_blank" className="text-blue-400">huggingface.co/settings/tokens</a>
              </p>
            </div>

            <div className="mb-4">
              <label className="block text-gray-400 text-sm mb-2">AI Model</label>
              <select 
                value={hfModel}
                onChange={(e) => { setHfModel(e.target.value); localStorage.setItem('hf_model', e.target.value); }}
                className="w-full bg-gray-700 text-white px-4 py-2 rounded">
                <option value="microsoft/Phi-3-mini-4k-instruct">Phi-3 Mini (Recommended)</option>
                <option value="meta-llama/Llama-3.2-3B-Instruct">Llama 3.2</option>
                <option value="mistralai/Mistral-7B-Instruct-v0.2">Mistral 7B</option>
              </select>
            </div>
          </div>
        </div>
      );

      // Modals
      const renderModal = () => {
        if (!modal) return null;

        if (modal === 'addHabit') {
          return (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
              <div className="bg-gray-800 rounded-lg p-6 max-w-md w-full">
                <h2 className="text-2xl font-bold text-white mb-4">Add New Habit</h2>
                <input 
                  type="text"
                  placeholder="Habit name"
                  value={formData.name || ''}
                  onChange={(e) => setFormData({...formData, name: e.target.value})}
                  className="w-full bg-gray-700 text-white px-4 py-2 rounded mb-3" />
                <textarea 
                  placeholder="Description"
                  value={formData.description || ''}
                  onChange={(e) => setFormData({...formData, description: e.target.value})}
                  className="w-full bg-gray-700 text-white px-4 py-2 rounded mb-3" rows="3" />
                <select 
                  value={formData.mode || 'habit'}
                  onChange={(e) => setFormData({...formData, mode: e.target.value})}
                  className="w-full bg-gray-700 text-white px-4 py-2 rounded mb-4">
                  <option value="habit">Habit</option>
                  <option value="progress">Progress</option>
                </select>
                <div className="flex gap-3">
                  <button onClick={addHabit} className="flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Add</button>
                  <button onClick={() => setModal(null)} className="flex-1 bg-gray-600 text-white py-2 rounded hover:bg-gray-700">Cancel</button>
                </div>
              </div>
            </div>
          );
        }

        if (modal === 'checkIn') {
          return (
            <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
              <div className="bg-gray-800 rounded-lg p-6 max-w-md w-full">
                <h2 className="text-2xl font-bold text-white mb-4">Check In</h2>
                <textarea 
                  placeholder="What did you accomplish today? (10-500 characters)"
                  value={formData.notes || ''}
                  onChange={(e) => setFormData({...formData, notes: e.target.value})}
                  className="w-full bg-gray-700 text-white px-4 py-2 rounded mb-4" 
                  rows="4" />
                <div className="flex gap-3">
                  <button 
                    onClick={() => checkIn(formData.habitId)} 
                    disabled={!formData.notes || formData.notes.length < 10}
                    className="flex-1 bg-green-600 text-white py-2 rounded hover:bg-green-700 disabled:opacity-50">
                    Check In
                  </button>
                  <button onClick={() => setModal(null)} className="flex-1 bg-gray-600 text-white py-2 rounded hover:bg-gray-700">Cancel</button>
                </div>
              </div>
            </div>
          );
        }
      };

      return (
        <div className="min-h-screen bg-gray-900">
          {/* Sidebar */}
          <div className="fixed left-0 top-0 h-full w-64 bg-gray-800 p-6">
            <h1 className="text-2xl font-bold text-white mb-8">Streak Tracker</h1>
            <nav className="space-y-2">
              <button 
                onClick={() => { setView('dashboard'); setSelectedHabit(null); }}
                className={`w-full text-left px-4 py-3 rounded ${view === 'dashboard' ? 'bg-blue-600 text-white' : 'text-gray-400 hover:bg-gray-700'}`}>
                🏠 Dashboard
              </button>
              <button 
                onClick={() => setView('settings')}
                className={`w-full text-left px-4 py-3 rounded ${view === 'settings' ? 'bg-blue-600 text-white' : 'text-gray-400 hover:bg-gray-700'}`}>
                ⚙️ Settings
              </button>
            </nav>
          </div>

          {/* Main Content */}
          <div className="ml-64">
            {selectedHabit ? renderHabitDetail() : view === 'settings' ? renderSettings() : renderDashboard()}
          </div>

          {/* Toast */}
          {toast && (
            <div className="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg">
              {toast}
            </div>
          )}

          {/* Modals */}
          {renderModal()}
        </div>
      );
    }

    // Render app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
